<idea-plugin>
    <id>com.kgboard.rgb</id>
    <name>KGBoard</name>
    <vendor>KGBoard</vendor>

    <description><![CDATA[
    <h2>KGBoard — RGB Keyboard Integration for JetBrains IDEs</h2>

    <p>Transform your RGB keyboard into a real-time IDE status display using <b>OpenRGB</b>.</p>

    <h3>Features</h3>
    <ul>
        <li><b>Build events</b> — green flash on success, red on failure, yellow pulse in progress</li>
        <li><b>Test results</b> — blue pulse while running, green on pass, red on fail</li>
        <li><b>Debug mode</b> — purple pulse, flash on breakpoint hit</li>
        <li><b>Git status</b> — per-key indicator (uncommitted, conflict, unpushed, clean)</li>
        <li><b>Git branch rules</b> — regex-based background color per branch name</li>
        <li><b>Code analysis</b> — three-state indicator (errors/warnings/clean)</li>
        <li><b>TODO indicator</b> — lights up when current file has TODO items</li>
        <li><b>File save flash</b> — brief flash on Ctrl+S</li>
        <li><b>Pomodoro timer</b> — gradient during work, pulse during break</li>
        <li><b>Rainbow &amp; Wave effects</b> — animated lighting patterns</li>
        <li><b>Multi-device</b> — control multiple RGB devices with different roles</li>
        <li><b>IDE notifications</b> — indexing (orange), low memory (red)</li>
        <li><b>Focus handling</b> — dim keyboard when IDE loses focus</li>
    </ul>

    <h3>Requirements</h3>
    <ul>
        <li><a href="https://openrgb.org">OpenRGB</a> running with SDK Server enabled (port 6742)</li>
        <li>IntelliJ IDEA 2024.3+</li>
    </ul>
    ]]></description>

    <depends>com.intellij.modules.platform</depends>
    <depends>com.intellij.modules.java</depends>
    <depends optional="true" config-file="kgboard-git.xml">Git4Idea</depends>

    <extensions defaultExtensionNs="com.intellij">
        <!-- Application-level service: OpenRGB connection manager -->
        <applicationService
                serviceImplementation="com.kgboard.rgb.client.OpenRgbConnectionService"/>

        <!-- Project-level service: LED compositor (buffered rendering engine) -->
        <projectService
                serviceImplementation="com.kgboard.rgb.effect.LedCompositor"/>

        <!-- Project-level service: effect manager per project (facade over compositor) -->
        <projectService
                serviceImplementation="com.kgboard.rgb.effect.EffectManagerService"/>

        <!-- Settings page (application-level) -->
        <applicationConfigurable
                parentId="tools"
                instance="com.kgboard.rgb.settings.KgBoardConfigurable"
                id="com.kgboard.rgb.settings"
                displayName="KGBoard RGB"/>

        <!-- Settings page (project-level) -->
        <projectConfigurable
                parentId="com.kgboard.rgb.settings"
                instance="com.kgboard.rgb.settings.KgBoardProjectConfigurable"
                id="com.kgboard.rgb.settings.project"
                displayName="Project Settings"/>

        <!-- Persistent settings storage -->
        <applicationService
                serviceImplementation="com.kgboard.rgb.settings.KgBoardSettings"/>

        <!-- Keyboard layout mapping service -->
        <applicationService
                serviceImplementation="com.kgboard.rgb.layout.KeyboardLayoutService"/>

        <!-- Project-level settings -->
        <projectService
                serviceImplementation="com.kgboard.rgb.settings.KgBoardProjectSettings"/>

        <!-- Project-level services: Phase 2 features -->
        <projectService
                serviceImplementation="com.kgboard.rgb.bridge.CodeAnalysisListener"/>
        <projectService
                serviceImplementation="com.kgboard.rgb.bridge.IdeNotificationListener"/>
        <projectService
                serviceImplementation="com.kgboard.rgb.bridge.ShortcutHighlightService"/>
        <projectService
                serviceImplementation="com.kgboard.rgb.bridge.TodoIndicatorListener"/>
        <projectService
                serviceImplementation="com.kgboard.rgb.bridge.DebuggerBreakpointListener"/>
        <projectService
                serviceImplementation="com.kgboard.rgb.pomodoro.PomodoroTimerService"/>

        <!-- Status bar widgets -->
        <statusBarWidgetFactory
                id="KGBoardStatus"
                implementation="com.kgboard.rgb.bridge.KgBoardStatusWidgetFactory"/>
        <statusBarWidgetFactory
                id="KGBoardPomodoro"
                implementation="com.kgboard.rgb.pomodoro.PomodoroWidgetFactory"/>

        <!-- Auto-connect on project open -->
        <postStartupActivity
                implementation="com.kgboard.rgb.bridge.KgBoardStartupActivity"/>
    </extensions>

    <actions>
        <group id="KGBoard.ToolsMenu" text="KGBoard" popup="true">
            <add-to-group group-id="ToolsMenu" anchor="last"/>
            <action id="KGBoard.Pomodoro.StartStop"
                    class="com.kgboard.rgb.pomodoro.PomodoroStartStopAction"
                    text="Pomodoro: Start/Stop"/>
            <action id="KGBoard.Pomodoro.Skip"
                    class="com.kgboard.rgb.pomodoro.PomodoroSkipAction"
                    text="Pomodoro: Skip Phase"/>
        </group>
    </actions>

    <applicationListeners>
        <!-- IDE focus gain/loss -->
        <listener
                class="com.kgboard.rgb.bridge.FocusEventListener"
                topic="com.intellij.openapi.application.ApplicationActivationListener"/>

        <!-- IDE shutdown -->
        <listener
                class="com.kgboard.rgb.bridge.AppLifecycleHandler"
                topic="com.intellij.ide.AppLifecycleListener"/>

        <!-- Project open/close -->
        <listener
                class="com.kgboard.rgb.bridge.ProjectFocusListener"
                topic="com.intellij.openapi.project.ProjectManagerListener"/>

        <!-- File save flash -->
        <listener
                class="com.kgboard.rgb.bridge.FileSaveListener"
                topic="com.intellij.openapi.fileEditor.FileDocumentManagerListener"/>
    </applicationListeners>

    <projectListeners>
        <!-- Build events listener -->
        <listener
                class="com.kgboard.rgb.bridge.BuildEventListener"
                topic="com.intellij.openapi.compiler.CompilationStatusListener"/>

        <!-- Execution events listener -->
        <listener
                class="com.kgboard.rgb.bridge.ExecutionEventListener"
                topic="com.intellij.execution.ExecutionListener"/>

        <!-- Test events listener -->
        <listener
                class="com.kgboard.rgb.bridge.TestEventListener"
                topic="com.intellij.execution.testframework.sm.runner.SMTRunnerEventsListener"/>
    </projectListeners>
</idea-plugin>
